// Generated by CoffeeScript 1.3.3
(function() {
  var $, History, ajaxHelpers, listenHeight, momentize, sidebarHeight, siteUrl, wookmark;

  $ = jQuery;

  $(document).ready(function() {
    var State;
    ajaxHelpers();
    State = History.getState();
    console.log(State);
    return wookmark();
  });

  window.onresize = function(event) {
    sidebarHeight();
    return listenHeight();
  };

  ajaxHelpers = function() {
    sidebarHeight();
    listenHeight();
    return momentize();
  };

  History = window.History;

  siteUrl = "http://" + top.location.host.toString();

  $(document).delegate('a[href="/listen"], a[href="/directory"], a[href="/settings"], a[href="/help"]', "click", function(e) {
    var State;
    e.preventDefault();
    State = History.getState();
    console.log(State);
    return History.pushState({}, "", $(e.currentTarget).attr('href'));
  });

  History.Adapter.bind(window, 'statechange', function() {
    var State;
    State = History.getState();
    History.log(State.data, State.title, State.url);
    if (State.hash === '/listen') {
      return $.ajax({
        type: 'POST',
        url: '/listen',
        success: function(data) {
          $('.hark-container').replaceWith(data);
          return ajaxHelpers();
        }
      });
    } else if (State.hash === '/directory') {
      return $.ajax({
        type: 'POST',
        url: '/directory',
        success: function(data) {
          $('.hark-container').html(data);
          ajaxHelpers();
          return wookmark();
        }
      });
    } else if (State.hash === '/settings') {
      return $.ajax({
        type: 'POST',
        url: '/settings',
        success: function(data) {
          $('.hark-container').html(data);
          return ajaxHelpers();
        }
      });
    } else if (State.hash === '/help') {
      return $.ajax({
        type: 'POST',
        url: '/help',
        success: function(data) {
          $('.hark-container').html(data);
          return ajaxHelpers();
        }
      });
    } else {

    }
  });

  $(document).delegate('.current-item, .current-feed', 'click', function(e) {
    var data;
    e.preventDefault();
    if ($(e.currentTarget).is('.blank')) {
      console.log('blank');
    } else {
      data = {
        feedID: $(this).attr('href').split('/')[3]
      };
      return $.ajax({
        type: 'POST',
        data: data,
        url: '/listen/podcast/' + data.feedID,
        success: function(data) {
          $('.primary').html(data);
          return ajaxHelpers();
        }
      });
    }
  });

  sidebarHeight = function() {
    var c_height, c_width, sidebar;
    c_width = $(window).width();
    c_height = $(window).height();
    sidebar = $('.sidebar');
    return $('.sidebar').css('height', c_height - 171);
  };

  listenHeight = function() {
    var c_height, c_width, listen;
    c_width = $(window).width();
    c_height = $(window).height();
    listen = $('.primary');
    return $('.primary').css('height', c_height - 171);
  };

  $(document).delegate('.categories li:not(.safe), .subscriptions li:not(.safe), .currently-playing li:not(.heading), .choose-settings li:not(.safe), .questions li:not(.safe)', 'hover', function(e) {
    if (e.type === 'mouseenter') {
      return $('.hover-er').css('top', $(e.currentTarget).offset().top + 0).css('opacity', '100').css('height', $(e.currentTarget).height());
    } else {
      if ($(e.currentTarget).children('.sidebar-expander').is('.expanded')) {

      } else {
        return $('.hover-er').css('opacity', '0');
      }
    }
  });

  momentize = function() {
    return $('.moment').each(function(i) {
      $(this).attr('data-date', $(this).text());
      return $(this).text(moment($(this).text()).fromNow());
    });
  };

  $(document).delegate('.act-add', 'click', function(e) {
    return $('.add-feed').toggle();
  });

  $('.add-feed').live('keypress', function(e) {
    var data;
    if (e.which === 13) {
      data = {
        url: $(e.currentTarget).val()
      };
      return $.ajax({
        type: 'POST',
        url: '/listen/add',
        data: data,
        success: function(data) {
          $('.hark-container').html(data);
          $('.add-feed').val('');
          $('.add-feed').hide();
          return ajaxHelpers();
        }
      });
    }
  });

  $(document).delegate('.act-update', 'click', function(e) {
    e.preventDefault();
    $('.act-update a').text('Updating...');
    return $.ajax({
      type: 'POST',
      url: '/listen/update',
      success: function(data) {
        $('.act-update a').text('Update');
        $('.primary').html(data);
        return ajaxHelpers();
      }
    });
  });

  $(document).delegate('.allFeeds a', 'click', function(e) {
    e.preventDefault();
    return $.ajax({
      type: 'POST',
      url: '/listen/podcast/all',
      success: function(data) {
        $('.primary').html(data);
        return ajaxHelpers();
      }
    });
  });

  $(document).delegate('.loadFeed, .loadFeedFromItem', 'click', function(e) {
    var data;
    e.preventDefault();
    data = {
      feedID: $(this).attr('href').split('/')[3]
    };
    return $.ajax({
      type: 'POST',
      data: data,
      url: '/listen/podcast/' + data.feedID,
      success: function(data) {
        $('.primary').html(data);
        return ajaxHelpers();
      }
    });
  });

  $(document).delegate('.sidebar-expander', 'click', function(e) {
    if ($(e.currentTarget).is('.expanded')) {
      $(e.currentTarget).parent().animate({
        height: '46px'
      }, 300);
      $('.hover-er').animate({
        height: '46px'
      }, 80);
      $(e.currentTarget).next().removeClass('undocked').fadeOut(300);
      $(e.currentTarget).parent().removeClass('active');
      return $(e.currentTarget).removeClass('expanded');
    } else {
      $('.sidebar-action-edit-input').hide();
      $(e.currentTarget).parent().animate({
        height: '112px'
      }, 300).css('overflow', 'visible');
      $('.hover-er').animate({
        height: '102px'
      }, 80);
      $(e.currentTarget).next().addClass('undocked').fadeIn(300);
      $(e.currentTarget).parent().addClass('active');
      return $(e.currentTarget).addClass('expanded');
    }
  });

  $(document).delegate('.sidebar-action-edit', 'click', function(e) {
    e.preventDefault();
    $('.sidebar-action-edit-input').val('');
    $('.sidebar-action-edit-input').fadeIn(300);
    return $('.sidebar-action-edit-input').val($(e.currentTarget).parent().siblings('.loadFeed').text());
  });

  $('.sidebar-action-edit-input').live('keypress', function(e) {
    var data;
    if (e.which === 13) {
      data = {
        feedID: $(this).prev().attr('href').split('/')[3],
        feedName: $(this).val()
      };
      console.log(data);
      return $.ajax({
        type: 'POST',
        data: data,
        url: '/listen/edit/' + data.feedID,
        success: function(data) {
          $('.hark-container').html(data);
          return ajaxHelpers();
        }
      });
    }
  });

  $(document).delegate('.sidebar-action-remove', 'click', function(e) {
    var data;
    e.preventDefault();
    data = {
      feedID: $(e.currentTarget).attr('href').split('/')[3]
    };
    return $.ajax({
      type: 'POST',
      data: data,
      url: '/listen/remove/' + data.feedID,
      success: function(data) {
        console.log(data);
        $('.hark-container').html(data);
        return ajaxHelpers();
      }
    });
  });

  $(document).delegate('.podcast-item:not(.selected)', 'click', function(e) {
    $('.selected').children('.podcastDescription').fadeOut(500);
    $('.podcast-item').removeClass('selected');
    $(e.currentTarget).addClass('selected');
    return $('.act-listen, .act-mark, .act-read, .act-source, .act-download').removeClass('inactive').addClass('active');
  });

  $(document).delegate('.selected', 'click', function(e) {
    $('.selected').children('.podcastDescription').fadeOut(500);
    $(e.currentTarget).removeClass('selected');
    return $('.act-listen, .act-mark, .act-read, .act-source, .act-download').removeClass('active').addClass('inactive');
  });

  $(document).delegate('.item-actions-listen', 'click', function(e) {
    return console.log('hi');
  });

  $(document).delegate('.act-read.active', 'click', function(e) {
    $('.selected').children('.podcastDescription').toggle(500);
    return false;
  });

  $(document).delegate('.act-source.active', 'click', function(e) {
    return window.open($('.selected').attr('data-source'), '_newtab');
  });

  $(document).delegate('.act-download.active', 'click', function(e) {
    return window.open($('.selected').attr('data-file'), '_newtab');
  });

  $(document).delegate('.act-sorting', 'click', function(e) {
    console.log('hi');
    return $('.act-sorting ul').toggle();
  });

  $(document).delegate('.podcast-title a', 'hover', function(e) {
    if (e.type === 'mouseenter') {
      if ($(e.currentTarget).height() > $(e.currentTarget).parent().height()) {
        return $(e.currentTarget).animate({
          'margin-top': $(e.currentTarget).parent().height() - $(e.currentTarget).height()
        }, 1000);
      }
    } else {
      return $(e.currentTarget).animate({
        'margin-top': 0
      }, 1000, "linear");
    }
  });

  wookmark = function() {
    $('.directory-item').wookmark({
      container: $('.directory-main'),
      offset: 20,
      autoResize: true
    });
    return console.log('wookmarking it');
  };

  $(document).delegate('.directory-feed-subscribe', 'click', function(e) {
    e.preventDefault();
    console.log($(e.currentTarget).attr('href'));
    return $.ajax({
      type: 'POST',
      url: $(e.currentTarget).attr('href'),
      success: function(data) {
        return console.log('?');
      }
    });
  });

  $(document).delegate('.category a:not(.loadAll)', 'click', function(e) {
    e.preventDefault();
    return $.ajax({
      type: 'POST',
      url: $(this).attr('href'),
      data: $(this).attr('href'),
      success: function(data) {
        $('.primary').html(data);
        console.log(data);
        ajaxHelpers();
        return wookmark();
      }
    });
  }).delegate('.category a.loadAll', 'click', function(e) {
    e.preventDefault();
    return $.ajax({
      type: 'POST',
      url: $(this).attr('href'),
      data: $(this).attr('href'),
      success: function(data) {
        $('.hark-container').html(data);
        ajaxHelpers();
        return wookmark();
      }
    });
  });

}).call(this);
